# Proyecto 1 - Sistemas de Bases de Datos 1
### Objetivos
General:
* Utilizar consultas para presentar la información requerida de una base
de datos relacional.

Específicos:
* Aprender a realizar cargas masivas desde archivos brindados.
* Aprender a utilizar modelar y crear una base de datos.
* Creación de consultas óptimas y funcionales para extraer reportería 
de una base de datos

### Funcionalidades
#### Carga y modelo de datos

Para la resolucion del proyecto y como primer paso, se cargo toda la informarcion del archivo de origen (.CSV) a una tabla temporal por medio del asistente de DBeaver.

Una vez cargada la informacion se crearon cierta cantidad de entidades, en este caso
hicimos uso de las instrucciones *CREATE TABLE nombre_tabla (atributos)* para cada uno de estos, dependiendo de la informacion
que cada entidad va almacenar.

    CREATE TABLE ubicaciones_victima(
    id_ubicacion_v int generated by default as identity not null,
    id_ubicacion int,
    id_victima int,
    dt_llegada timestamp(6),
    dt_salida timestamp(6),
    primary key(id_ubicacion_v),
    constraint fk_ubicacion foreign key (id_ubicacion) references ubicacion(id_ubicacion),
    constraint fk_victima_ubi foreign key (id_victima) references victima(id_victima)
    );

Posteriormente, se llenaron las entidades con la informacion del archivo de origen (.CSV) que se cargó y almaceno en nuestro sistema
por medio de una tabla temporal. Esto con el uso de las instrucciones *INSERT INTO nombre_tabla_destino(atributos a llenar) SELECT columnas_tabla_origen FROM nombre
_tabla_origen*. De igual manera se utilizaron otras instrucciones como *INNER JOINS*, dependiendo la informacion solicitada.

    ------- INGRESAR DATOS A *** UBICACIONES_VICTIMA *** -----
    INSERT INTO UBICACIONES_VICTIMA(id_ubicacion, id_victima, dt_llegada, dt_salida)
    SELECT DISTINCT ubi.ID_UBICACION, v.ID_VICTIMA, 
    TO_DATE(TT.FECHA_LLEGADA ,'DD/MM/YYYY HH24:MI'), 
    TO_DATE(TT.FECHA_RETIRO ,'DD/MM/YYYY HH24:MI') 
    FROM DB_EXCEL_OG TT
    INNER JOIN UBICACION ubi
      ON TT.UBICACION_VICTIMA = UBI.DIRECCION
    INNER JOIN VICTIMA v
      ON TT.NOMBRE_VICTIMA = v.NOMBRE AND TT.APELLIDO_VICTIMA = V.APELLIDO

Tomando en cuenta que, se llenaron primero nuestras entidades no correspondientes a romper una relacion muchos a muchos.

Una vez completo todo nuestro modelo de datos, se realizaron las consultas que se detallan en el anunciado.
En este procedimiento se utilizzaron instrucciones como *INNER JOINS, SUBQUERIES, CLAUSULA WHERE, GROUP BY y ORDER BY*.

#### API
Terminada la carga y modelo de datos, se inicio el trabajo de crear una API con la tecnologia *FASTAPI*.
Muy importante el uso de la libreria *cx_Oracle* para poder conectarnos a la base de datos y obtener nuestra informacion.

Para la conexion se utilizó lo siguiente:

    import cx_Oracle
    connection = cx_Oracle.connect("user","password","myservice")
    connection.autocommit = True
 
La instruccion *connection.autocommit = True* nos permitio actualizar los datos de las tablas desde nuestra API por medio de *INSERT INTO, UPDATE, etc*. Sin
esta instruccion, nuestras tablas quedarian vacias sin sufrir los cambios que necesitamos.

Por otro lado *myservice* hace referencia a nuestro archivo *tnsnames.ORA* donde se detalla la informacion de donde esta almacenada nuestra base de datos.

    MYSERVICE = (DESCRIPTION=
      (ADDRESS=
        (PROTOCOL=tcp)
        (HOST=ip_publica)
        (PORT=1521))
      (CONNECT_DATA=
        (SERVICE_NAME=ORCL18)))
        
A partir de esto, simplemente pasamos las consultas a nuestror codigo en python dependiendo de su ENDPOINT y su funcion.


    @app.get('/consulta1', tags=['consulta1'])
    def getConsulta1():
        cursor = dbConnection().cursor()
        sql = "SELECT DISTINCT h.NOMBRE ,  h.DIRECCION  , COUNT(v.ESTADO_VICTIMA) CANTIDAD_MUERTES \
                FROM HOSPITAL_UTILIZADO hu \
                INNER JOIN HOSPITAL h \
                    ON hu.ID_HOSPITAL = h.ID_HOSPITAL \
                INNER JOIN VICTIMA v  \
                    ON hu.ID_VICTIMA = v.ID_VICTIMA \
                WHERE v.ESTADO_VICTIMA = 'Muerte' OR v.FECHA_MUERTE IS NOT NULL \
                GROUP BY h.NOMBRE, h.DIRECCION \
                ORDER BY 3 DESC"
        cursor .execute(sql)
        data = cursor.fetchall()
        return data
